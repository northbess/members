<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>會員綁定中…</title>
  <meta name="theme-color" content="#06c755" />
  <style>
    html,body{height:100%}body{margin:0;font-family:ui-sans-serif,-apple-system,'Noto Sans TC',Arial;padding:0;background:#fff;display:flex;align-items:center;justify-content:center}
    .wrap{max-width:520px;width:100%;padding:28px 20px;text-align:center;color:#1f2937}
    .ring{width:44px;height:44px;border-radius:50%;border:4px solid rgba(6,199,85,.25);border-top-color:#06c755;animation:spin .8s linear infinite;margin:0 auto 14px}
    @keyframes spin{to{transform:rotate(360deg)}}
    .muted{color:#6b7280;font-size:14px}
    .err{color:#b91c1c}
    .btn{margin-top:14px;display:inline-block;background:#06c755;color:#fff;padding:10px 14px;border-radius:10px;text-decoration:none;font-weight:700}
    .small{color:#9ca3af;font-size:12px;margin-top:10px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="ring"></div>
    <div id="title">會員綁定中，請稍候…</div>
    <div id="msg" class="muted">此視窗會在成功後自動關閉</div>
    <div id="fallback" class="small" style="display:none"></div>
  </div>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script>
    // ======= 必填：LIFF_ID 與 GAS /exec URL（可用 ?liffId=...&exec=... 覆蓋） =======
    let LIFF_ID  = "2008228314-bRlag6ZR";
    let GAS_EXEC = "https://script.google.com/macros/s/AKfycbz6HmtsSr1Zz00_itkzh4T5zjhOIKxnwjHzxvoGPmeRYqNmyooVLb6HiRIRrTQWoutN/exec";

    // ======= 新增：推送選項的預設值（可被 URL 覆蓋） =======
    // push: 'both' | 'info' | 'cmd' | 'none'
    // showuid: '1'（回傳 userId）或 '0'（不回傳）
    // tier: '特優會員' / '研究會員' / '師資'（可不帶）
    let DEFAULT_PUSH    = 'both';
    let DEFAULT_SHOWUID = '1';
    let DEFAULT_TIER    = ''; // 例如 '特優會員'；不確定就留空

    const u  = new URL(location.href);
    const qp = u.searchParams;
    if (qp.get('liffId')) LIFF_ID = qp.get('liffId');
    if (qp.get('exec'))   GAS_EXEC = qp.get('exec');

    // 讀取（或使用預設）
    const PUSH    = (qp.get('push')    || DEFAULT_PUSH).toLowerCase();
    const SHOWUID = (qp.get('showuid') || DEFAULT_SHOWUID);
    const TIER    = (qp.get('tier')    || DEFAULT_TIER);

    const $ = (s)=>document.querySelector(s);
    const deepLink = ()=> 'https://liff.line.me/' + encodeURIComponent(LIFF_ID) + location.search;

    async function bindAndClose(idToken){
      try{
        const params = new URLSearchParams();
        params.set('bind','1');
        params.set('id_token', idToken || '');
        params.set('push', PUSH);            // ← 新增：推播內容
        params.set('showuid', SHOWUID);      // ← 新增：是否同時回 userId
        if (TIER) params.set('tier', TIER);  // ← 新增：若已知等級一起寫入

        const res = await fetch(GAS_EXEC + '?bind=1', {
          method:'POST',
          headers:{'Content-Type':'application/x-www-form-urlencoded'},
          body: params.toString()
        });
        const text = await res.text();
        // 後端成功會回：bind ok: Uxxxxxxxx
        if (/bind ok:\s*U/i.test(text)) {
          if (liff.isInClient()) liff.closeWindow();
          else location.href = deepLink();
        } else {
          $('#title').textContent = '綁定未成功';
          $('#msg').innerHTML = '<span class="err">' + (text || '請稍後再試') + '</span>';
          $('#fallback').style.display = 'block';
          $('#fallback').innerHTML = '仍可手動回到聊天視窗。';
        }
      }catch(err){
        $('#title').textContent = '網路異常';
        $('#msg').innerHTML = '<span class="err">' + String(err) + '</span>';
        $('#fallback').style.display = 'block';
        $('#fallback').innerHTML = '請稍後再試，或 <a class="btn" href="'+deepLink()+'">在 LINE 開啟</a>';
      }
    }

    (async ()=>{
      try{
        if (!LIFF_ID || !LIFF_ID.includes('-')){
          $('#title').textContent = '設定錯誤';
          $('#msg').innerHTML = '<span class="err">LIFF_ID 未設定或格式錯誤</span>';
          return;
        }
        if (!GAS_EXEC || !GAS_EXEC.includes('/exec')){
          $('#title').textContent = '設定錯誤';
          $('#msg').innerHTML = '<span class="err">GAS /exec URL 未設定</span>';
          return;
        }

        await liff.init({ liffId: LIFF_ID });
        if (!liff.isLoggedIn()) return liff.login({ redirectUri: location.href });

        const token = (function(){ try{return liff.getIDToken()}catch(e){return null} })();
        if (!token){
          if (!liff.isInClient()){ location.href = deepLink(); return; }
          $('#title').textContent = '無法取得授權資訊';
          $('#msg').innerHTML = '<span class="err">請關閉並重新由 LINE 選單開啟</span>';
          return;
        }

        // 送到 GAS 綁定並根據設定推送：userId / 會員資訊 / 指令一覽
        bindAndClose(token);
      }catch(err){
        $('#title').textContent = '初始化失敗';
        $('#msg').innerHTML = '<span class="err">' + String(err) + '</span>';
        $('#fallback').style.display = 'block';
        $('#fallback').innerHTML = '請稍後再試，或 <a class="btn" href="'+deepLink()+'">在 LINE 開啟</a>';
      }
    })();
  </script>
</body>
</html>
