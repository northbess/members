<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>太乙堂｜會員綁定</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
  <h3>會員綁定</h3>
  <div>
    <label>等級：
      <select id="tier">
        <option value="特優會員">特優會員</option>
        <option value="研究會員">研究會員</option>
        <option value="師資">師資</option>
      </select>
    </label>
  </div>
  <button id="bindBtn">綁定</button>
  <button id="meBtn">查詢</button>
  <button id="unbindBtn">解除綁定</button>

<script>
  // 替換成你的設定
  var LIFF_ID = "2008228314-bRlag6ZR";
  var ADMIN_KEY = "taito2025abc123";
  var API_BASE = "https://script.google.com/macros/s/AKfycbz6HmtsSr1Zz00_itkzh4T5zjhOIKxnwjHzxvoGPmeRYqNmyooVLb6HiRIRrTQWoutN/exec";

  function qs(o){
    var s=[], k;
    for(k in o){ if(o.hasOwnProperty(k) && o[k]!==undefined)
      s.push(encodeURIComponent(k)+"="+encodeURIComponent(o[k]));
    }
    return s.join("&");
  }

  function get(url){ return fetch(url, { method: "GET" }).then(function(r){return r.json()}); }

  liff.init({ liffId: LIFF_ID }).then(function(){
    return liff.getProfile();
  }).then(function(profile){
    var userId = profile.userId;
    var displayName = profile.displayName || "";

    document.getElementById("bindBtn").onclick = function(){
      var tierKey = document.getElementById("tier").value;
      var url = API_BASE + "?" + qs({
        fn:"bind", key:ADMIN_KEY, userId:userId, displayName:displayName, tierKey:tierKey
      });
      get(url).then(function(j){
        alert(j.ok ? "綁定成功：" + tierKey : "綁定失敗：" + j.error);
      }).catch(function(err){ alert("綁定錯誤：" + err); });
    };

    document.getElementById("meBtn").onclick = function(){
      var url = API_BASE + "?" + qs({ fn:"me", key:ADMIN_KEY, userId:userId });
      get(url).then(function(j){
        alert(j.ok ? ("目前等級：" + j.tierKey) : ("查詢失敗：" + j.error));
      }).catch(function(err){ alert("查詢錯誤：" + err); });
    };

    document.getElementById("unbindBtn").onclick = function(){
      var url = API_BASE + "?" + qs({ fn:"unbind", key:ADMIN_KEY, userId:userId });
      get(url).then(function(j){
        alert(j.ok ? "已解除綁定" : ("解除失敗：" + j.error));
      }).catch(function(err){ alert("解除錯誤：" + err); });
    };
  }).catch(function(e){
    alert("LIFF 初始化失敗：" + e);
  });
</script>
</body>
</html>
