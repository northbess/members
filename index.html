<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>會員綁定</title>
  <meta name="theme-color" content="#06c755" />
  <style>
    html,body{height:100%}
    body{margin:0;font-family:ui-sans-serif,-apple-system,'Noto Sans TC',Arial;padding:0;background:#fff;display:flex;align-items:center;justify-content:center}
    .wrap{max-width:520px;width:100%;padding:28px 20px;text-align:center;color:#1f2937;display:none}
    .ring{width:44px;height:44px;border-radius:50%;border:4px solid rgba(6,199,85,.25);border-top-color:#06c755;animation:spin .8s linear infinite;margin:0 auto 14px}
    @keyframes spin{to{transform:rotate(360deg)}}
    .muted{color:#6b7280;font-size:14px}
    .err{color:#b91c1c}
    .btn{margin-top:14px;display:inline-block;background:#06c755;color:#fff;padding:10px 14px;border-radius:10px;text-decoration:none;font-weight:700}
    .link{display:inline-block;margin-top:10px}
    .small{color:#9ca3af;font-size:12px;margin-top:10px}
    .hide{display:none}
  </style>
</head>
<body>
  <div class="wrap" id="wrap">
    <div id="stage-idle" class="">
      <!-- 初始不顯示任何文字，避免誤會 -->
    </div>

    <div id="stage-login" class="hide">
      <div id="title-login">請允許授權以完成綁定</div>
      <div class="muted">點選下方按鈕，同意授權後會自動回到此頁完成綁定。</div>
      <a id="btn-login" href="javascript:void(0)" class="btn">登入並同意</a>
    </div>

    <div id="stage-binding" class="hide">
      <div class="ring"></div>
      <div id="title-binding">綁定中，請稍候…</div>
      <div id="msg-binding" class="muted">完成後會自動關閉視窗</div>
    </div>

    <div id="stage-error" class="hide">
      <div id="title-error">操作未完成</div>
      <div id="msg-error" class="err"></div>
      <div id="fallback" class="small"></div>
    </div>
  </div>

  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script>
    // ===== 需設定：LIFF_ID 與 GAS /exec，可用 ?liffId=...&exec=... 覆蓋 =====
    var LIFF_ID  = "2008228314-bRlag6ZR";
    var GAS_EXEC = "https://script.google.com/macros/s/AKfycbz6HmtsSr1Zz00_itkzh4T5zjhOIKxnwjHzxvoGPmeRYqNmyooVLb6HiRIRrTQWoutN/exec";

    (function(){
      var u = new URL(location.href);
      if (u.searchParams.get('liffId')) LIFF_ID  = u.searchParams.get('liffId');
      if (u.searchParams.get('exec'))   GAS_EXEC = u.searchParams.get('exec');
    })();

    function $(s){ return document.querySelector(s); }
    function show(id){
      $('#wrap').style.display = 'block';
      ['#stage-idle','#stage-login','#stage-binding','#stage-error'].forEach(function(sel){
        var el = $(sel); if (!el) return;
        el.classList.add('hide');
      });
      var el = $(id); if (el) el.classList.remove('hide');
    }
    function deepLink(){
      return 'https://liff.line.me/' + encodeURIComponent(LIFF_ID) + location.search;
    }

    async function bindAndClose(idToken){
      try{
        show('#stage-binding');
        var params = new URLSearchParams();
        params.set('id_token', idToken || '');
        // 用 POST + ?bind=1（符合 GAS 的 handleLiffBind_ 入口）
        var res = await fetch(GAS_EXEC + '?bind=1', {
          method:'POST',
          headers:{'Content-Type':'application/x-www-form-urlencoded'},
          body: params.toString()
        });
        var text = await res.text();

        if (/bind ok:\s*U/i.test(text)) {
          if (liff.isInClient()) {
            liff.closeWindow();
          } else {
            // 外部瀏覽器：導回聊天（用深連結打開 LINE）
            location.href = deepLink();
          }
        } else {
          show('#stage-error');
          $('#msg-error').textContent = text || '請稍後再試';
          $('#fallback').innerHTML = '仍可手動回到 LINE 聊天視窗。';
        }
      } catch (err) {
        show('#stage-error');
        $('#msg-error').textContent = String(err);
        $('#fallback').innerHTML = '請稍後再試，或 <a class="btn" href="'+deepLink()+'">在 LINE 開啟</a>';
      }
    }

    (async function main(){
      // 初始完全不顯示任何文字（避免「綁定中」預覽）
      $('#wrap').style.display = 'none';

      try{
        // 基本設定檢查
        if (!LIFF_ID || LIFF_ID.indexOf('-') < 0){
          show('#stage-error');
          $('#msg-error').textContent = 'LIFF_ID 未設定或格式錯誤';
          return;
        }
        if (!GAS_EXEC || GAS_EXEC.indexOf('/exec') < 0){
          show('#stage-error');
          $('#msg-error').textContent = 'GAS /exec URL 未設定';
          return;
        }

        await liff.init({ liffId: LIFF_ID });

        // 外部瀏覽器：盡量直接導回 LINE 內開啟（不露出「綁定中」）
        if (!liff.isInClient()){
          // 若已登入且可取到 token，直接綁；否則導回 LINE
          var tokenOutside = (function(){ try{return liff.getIDToken()}catch(e){return null} })();
          if (tokenOutside) {
            show('#stage-binding');
            return bindAndClose(tokenOutside);
          }
          // 直接跳 LINE 開啟（避免在瀏覽器頁面看到任何誤導性預覽）
          location.replace(deepLink());
          // 如果使用者禁止跳轉，才補露畫面
          setTimeout(function(){
            if (document.visibilityState === 'visible'){
              show('#stage-login');
              $('#title-login').textContent = '請在 LINE 中開啟以完成綁定';
              $('#btn-login').textContent = '在 LINE 開啟';
              $('#btn-login').onclick = function(){ location.href = deepLink(); };
            }
          }, 600);
          return;
        }

        // LINE 內：若未登入，顯示明確授權提示與按鈕（而不是顯示「綁定中」）
        if (!liff.isLoggedIn()){
          show('#stage-login');
          $('#btn-login').onclick = function(){
            liff.login({ redirectUri: location.href });
          };
          return;
        }

        // 已登入 → 嘗試取得 id_token，只有此刻才顯示「綁定中」
        var token = (function(){ try{return liff.getIDToken()}catch(e){return null} })();
        if (!token){
          show('#stage-error');
          $('#msg-error').textContent = '無法取得授權資訊，請關閉並由 LINE 選單重新開啟';
          return;
        }

        // 送到 GAS 綁定並關窗
        return bindAndClose(token);

      }catch(err){
        show('#stage-error');
        $('#msg-error').textContent = String(err);
        $('#fallback').innerHTML = '請稍後再試，或 <a class="btn" href="'+deepLink()+'">在 LINE 開啟</a>';
      }
    })();
  </script>
</body>
</html>
