<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>我的專屬連結</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body{font-family:-apple-system,system-ui,"Noto Sans TC","Segoe UI",Roboto,"PingFang TC","Microsoft JhengHei",sans-serif;margin:16px}
    .muted{color:#666;font-size:14px}
  </style>
</head>
<body>
  <p id="msg">讀取中…</p>
  <script>
  (async function(){
    const LIFF_ID = '2008228314-VaawW8JM';                             // ← 改這裡（像 165xxxx-xxxxxx）
    const API_URL = 'https://script.google.com/macros/s/AKfycbz6HmtsSr1Zz00_itkzh4T5zjhOIKxnwjHzxvoGPmeRYqNmyooVLb6HiRIRrTQWoutN/exec';                        // ← 改這裡（像 https://script.google.com/macros/s/AKfycb.../exec）
    const msg = document.getElementById('msg');

    try{
      await liff.init({ liffId: LIFF_ID });
      // 必須在 LINE App 內，且要拿 openid 才會有 id_token
      if (!liff.isLoggedIn()) {
        liff.login({ scope: ['openid','profile'] });
        return;
      }
      const idt = liff.getIDToken();
      if (!idt) { msg.textContent = '取得 id_token 失敗，請在 LINE App 內開啟重試。'; return; }

      const url = API_URL + '?fn=li_my_link&id_token=' + encodeURIComponent(idt);
      const res = await fetch(url, { method:'GET' });
      const j = await res.json();

      if (!j || !j.ok) { msg.textContent = '查詢失敗：' + (j && j.error || 'unknown'); return; }
      if (!j.url) { msg.textContent = '目前未設定你的專屬連結（couponUrl），請洽客服。'; return; }

      // 一切正常 → 直接導向你的個人 couponUrl
      location.href = j.url;
    }catch(err){
      msg.textContent = 'LIFF/網路錯誤：' + err;
    }
  })();
  </script>
  <p class="muted">請務必在 LINE App 內開啟此頁。</p>
</body>
</html>
