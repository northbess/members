<!doctype html>
<html lang="zh-Hant">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>我的專屬連結</title>
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<style>
  body{font-family:system-ui,'Noto Sans TC',sans-serif;margin:16px;background:#fcf5e5}
  .box{max-width:520px;margin:auto}
  .card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:16px}
  .muted{color:#6b7280}
</style>
<body>
<div class="box">
  <h2 style="color:#4186b7">我的專屬連結</h2>
  <div class="card">
    <p id="msg">初始化中…</p>
  </div>
</div>

<script>
(function(){
  // TODO: 換成你的設定
  var LIFF_ID   = '2008228314-VaawW8JM'; // 你的 LIFF ID（有短橫）
  var GAS_EXEC  = 'https://script.google.com/macros/s/AKfycbz6HmtsSr1Zz00_itkzh4T5zjhOIKxnwjHzxvoGPmeRYqNmyooVLb6HiRIRrTQWoutN/exec'; // 你的最新 /exec

  function qs(obj){
    var s=[],k; for(k in obj){ if(obj.hasOwnProperty(k)&&obj[k]!=null){
      s.push(encodeURIComponent(k)+'='+encodeURIComponent(obj[k]));
    }} return s.join('&');
  }
  function setMsg(t){ document.getElementById('msg').textContent = t; }

  liff.init({ liffId: LIFF_ID }).then(function(){
    if(!liff.isLoggedIn()){ liff.login(); return; }
    setMsg('讀取連結中…');
    var idt = liff.getIDToken();
    if(!idt){ setMsg('取得 id_token 失敗'); return; }

    var url = GAS_EXEC + '?' + qs({ fn:'li_my_link', id_token: idt });
    return fetch(url, { method:'GET' })
      .then(function(r){ return r.json(); })
      .then(function(j){
        if(!j || !j.ok){ setMsg('查詢失敗：'+(j && (j.error||'') || '')); return; }
        if(!j.url){ setMsg('目前未設定你的專屬連結，請洽客服。'); return; }
        location.href = j.url; // ← 直接導向該用戶的 couponUrl
      });
  }).catch(function(err){
    setMsg('LIFF/網路錯誤：' + err);
  });
})();
</script>
</body>
</html>

